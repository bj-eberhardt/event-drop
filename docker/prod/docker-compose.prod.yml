services:
  web:
    image: beberhardt/eventdrop-web:latest
    restart: always
    build:
      context: ../..
      dockerfile: docker/prod/Dockerfile.prod
      args:
        VITE_API_BASE_URL: ${API_BASE_URL:-}
    environment:
      - UPLOAD_MAX_TOTAL_SIZE_BYTES=${UPLOAD_MAX_TOTAL_SIZE_BYTES:-0}
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-1}
    ports:
      - "${HTTP_PORT:-8080}:80"
    depends_on:
      - api

  api:
    image: beberhardt/eventdrop-api:latest
    build:
      context: ../..
      dockerfile: docker/Dockerfile
      target: prod
    environment:
      - PORT=8080
      - DATA_ROOT_PATH=/data/events
      - MAIN_DOMAIN=${MAIN_DOMAIN:-localhost}
      - ALLOWED_DOMAINS=${ALLOWED_DOMAINS:-localhost}
      - SUPPORT_SUBDOMAIN=${SUPPORT_SUBDOMAIN:-true}
      - ALLOW_EVENT_CREATION=${ALLOW_EVENT_CREATION:-true}
      - ENABLE_API_DOCS=${ENABLE_API_DOCS:-false}
      - UPLOAD_MAX_FILE_SIZE_BYTES=${UPLOAD_MAX_FILE_SIZE_BYTES:-0}
      - UPLOAD_MAX_TOTAL_SIZE_BYTES=${UPLOAD_MAX_TOTAL_SIZE_BYTES:-0}
    volumes:
      - ./data:/data/events
      - ./config:/config
      # - event-data:/data/events
    expose:
      - "8080"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'node -e "fetch(''http://localhost:8080/api/config'').then(r=>{if(!r.ok)process.exit(1)}).catch(()=>process.exit(1))"',
        ]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  event-data:
