map "${RATE_LIMIT_ENABLED}$request_method" $event_create_key {
  default "";
  ~^1POST $binary_remote_addr;
}

limit_req_zone $event_create_key zone=event_create:10m rate=2r/m;

map "${RATE_LIMIT_ENABLED}$request_method" $event_get_key {
  default "";
  ~^1GET $binary_remote_addr;
}

limit_req_zone $event_get_key zone=event_get:10m rate=10r/m;

map "${RATE_LIMIT_ENABLED}$request_method" $files_list_key {
  default "";
  ~^1GET $binary_remote_addr;
}

limit_req_zone $files_list_key zone=files_list:10m rate=60r/m;

map "${RATE_LIMIT_ENABLED}$request_method" $files_download_key {
  default "";
  ~^1GET $binary_remote_addr;
}

limit_req_zone $files_download_key zone=files_download:10m rate=120r/m;

map "${RATE_LIMIT_ENABLED}$request_method" $files_zip_key {
  default "";
  ~^1GET $binary_remote_addr;
}

limit_req_zone $files_zip_key zone=files_zip:10m rate=2r/m;

map "${RATE_LIMIT_ENABLED}$request_method" $files_upload_key {
  default "";
  ~^1POST $binary_remote_addr;
}

limit_req_zone $files_upload_key zone=files_upload:10m rate=30r/m;

server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  client_max_body_size ${UPLOAD_MAX_TOTAL_SIZE_BYTES};

  location /api/ {
    proxy_pass http://api:8080;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location = /api/events {
    limit_req zone=event_create burst=2 nodelay;
    limit_req_status 429;
    proxy_pass http://api:8080;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location ~ ^/api/events/[^/]+$ {
    limit_req zone=event_get burst=3 nodelay;
    limit_req_status 429;
    proxy_pass http://api:8080;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location ~ ^/api/events/[^/]+/files$ {
    limit_req zone=files_list burst=20 nodelay;
    limit_req zone=files_upload burst=10 nodelay;
    limit_req_status 429;
    proxy_pass http://api:8080;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location ~ ^/api/events/[^/]+/files\.zip$ {
    limit_req zone=files_zip burst=1 nodelay;
    limit_req_status 429;
    proxy_pass http://api:8080;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location ~ ^/api/events/[^/]+/files/ {
    limit_req zone=files_download burst=30 nodelay;
    limit_req_status 429;
    proxy_pass http://api:8080;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }


  location / {
    try_files $uri $uri/ /index.html;
  }
}
